get_project_id  = -> $('.project-panel').attr('data-project-id')
get_stage_id    = -> $('.stage-panel .active').attr('data-stage-id')

$(document).on 'ready', ->
  $(".baton-step-list .step-run").on 'click', ->
    icon = $(this).find('i')
    icon.removeClass('fa-play').addClass('fa-spinner fa-pulse')

    project_id = get_project_id()
    stage_id = get_stage_id()
    task_id = $(this).closest('.task-panel').attr('data-task-id')
    step_id = $(this).attr('data-step-id')

    console.log(project_id)
    console.log(stage_id)
    console.log(task_id)
    console.log(step_id)

    step_list = $(this).closest('li')
    $.ajax
      url: "/projects/"+project_id+"/stages/"+stage_id+"/tasks/"+task_id+"/steps/"+step_id+"/run"
      data:
        date: step_list.find('.param-date').val()
        direction: step_list.find('.param-direction').val()
      type: 'POST'
      error: (jqXHR, textStatus, errorThrown) ->
        $('body').append "AJAX Error: #{textStatus}"
      success: (data, textStatus, jqXHR) ->
        current_item = $('.baton-step-list a[data-step-id='+step_id+']')
        current_item.closest('li').find('.step-result').show().find('.panel-body').html( data['html'] )
        current_item.find('i').removeClass('fa-spinner fa-pulse').addClass('fa-repeat')

        if data['status'] == 'succeed'
          current_item.closest('li').find('.step-status i').removeClass('fa-arrow-right').removeClass('failed').addClass('fa-check')
        else
          current_item.closest('li').find('.step-status i').addClass('failed')
